# üöÄ HAProxy + Nginx Setup Script

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Bash](https://img.shields.io/badge/Bash-5.0+-green.svg)](https://www.gnu.org/software/bash/)
[![Platform](https://img.shields.io/badge/Platform-Ubuntu%2FDebian-blue.svg)](https://ubuntu.com/)

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ HAProxy + Nginx –¥–ª—è SNI-–º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ —Ç—Ä–∞—Ñ–∏–∫–∞ —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–π –ø–æ—Ä—Ç 443.

## üìñ –û–ø–∏—Å–∞–Ω–∏–µ

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞ –∑–∞ –æ–±—ã—á–Ω—ã–º HTTPS —Å–∞–π—Ç–æ–º:

- **HAProxy** - –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç SNI (Server Name Indication) –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç —Ç—Ä–∞—Ñ–∏–∫ –Ω–∞ –ø–æ—Ä—Ç—É 443
- **Nginx** - –æ—Ç–¥–∞–µ—Ç —Å–∞–π—Ç-–∑–∞–≥–ª—É—à–∫—É –¥–ª—è –ø—Ä–∏–∫—Ä—ã—Ç–∏—è
- **SNI-based routing** - –æ–¥–∏–Ω –ø–æ—Ä—Ç –¥–ª—è –≤—Å–µ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞ (—Å–µ—Ä–≤–∏—Å + —Å–∞–π—Ç)
- **–ü–æ–ª–Ω–∞—è –æ–±—Ñ—É—Å–∫–∞—Ü–∏—è** - —Ç—Ä–∞—Ñ–∏–∫ –Ω–µ–æ—Ç–ª–∏—á–∏–º –æ—Ç –æ–±—ã—á–Ω–æ–≥–æ HTTPS
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞** - –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

## üéØ –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

‚úÖ **–ï–¥–∏–Ω—ã–π –ø–æ—Ä—Ç 443** –¥–ª—è –≤—Å–µ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞  
‚úÖ **SNI-–º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è** –±–µ–∑ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞  
‚úÖ **–°–∞–π—Ç-–ø—Ä–∏–∫—Ä—ã—Ç–∏–µ** —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π SSL  
‚úÖ **–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞** - –≤–≤–æ–¥ –¥–æ–º–µ–Ω–æ–≤ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏  
‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å HAProxy  
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã** –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π  
‚úÖ **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ Let's Encrypt** SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤  
‚úÖ **–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** –Ω–∞ —Å–ª—É—á–∞–π —Å–±–æ–µ–≤  

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ –ö–ª–∏–µ–Ω—Ç—ã ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ –ü–æ—Ä—Ç 443 ‚îÇ
    ‚îÇ (HTTPS)  ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ HAProxy      ‚îÇ
    ‚îÇ (SNI –∞–Ω–∞–ª–∏–∑) ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
           ‚Üì                          ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ Service –¥–æ–º–µ–Ω—ã       ‚îÇ ‚îÇ –î—Ä—É–≥–∏–µ –¥–æ–º–µ–Ω—ã    ‚îÇ
    ‚îÇ (Service1.domain.com)‚îÇ ‚îÇ (site.domain.com)‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚Üì                          ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ Service –±—ç–∫–µ–Ω–¥—ã ‚îÇ           ‚îÇ Nginx  ‚îÇ
    ‚îÇ (5443-5445)     ‚îÇ           ‚îÇ (—Å–∞–π—Ç) ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò



## üìã –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

1. **–°–µ—Ä–≤–µ—Ä** —Å Ubuntu 22.04+ –∏–ª–∏ Debian 10+ –∏ root –¥–æ—Å—Ç—É–ø–æ–º
2. **–î–æ–º–µ–Ω** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `example.com`)
3. **DNS –¥–æ—Å—Ç—É–ø** –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–µ–π
4. **–û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ—Ä—Ç—ã**: 80 (–¥–ª—è SSL), 443
5. **–ú–∏–Ω–∏–º—É–º 1 –ì–ë** —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ

## –û–¥–∏–Ω –∫–ª–∏–∫ —É—Å—Ç–∞–Ω–æ–≤–∫–∞:

    bash <(curl -sL https://raw.githubusercontent.com/rasulovdd/HAProxy-Nginx/main/setup.sh)

---
---
## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

## 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫

–°–∫–∞—á–∞—Ç—å —Å–∫—Ä–∏–ø—Ç
    
```bash
curl -O https://github.com/rasulovdd/HAProxy-Nginx/setup.sh
```

–°–¥–µ–ª–∞—Ç—å –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
```bash
chmod +x setup.sh
```

–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å –ø—Ä–∞–≤–∞–º–∏ root
```bash
sudo ./setup.sh
```


## 2. –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–∫—Ä–∏–ø—Ç –ø—Ä–µ–¥–ª–æ–∂–∏—Ç:
- –í–≤–µ—Å—Ç–∏ –æ—Å–Ω–æ–≤–Ω–æ–π –¥–æ–º–µ–Ω –¥–ª—è —Å–∞–π—Ç–∞-–∑–∞–≥–ª—É—à–∫–∏ (–ø—Ä–∏–º–µ—Ä: myservice.com)
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Service –ø–æ–¥–¥–æ–º–µ–Ω—ã (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ –∏–ª–∏ –≤–≤–µ—Å—Ç–∏ —Å–≤–æ–∏)
- –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π

## 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞
–ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–∫–µ—Ç—ã
- –ù–∞—Å—Ç—Ä–æ–∏—Ç HAProxy –∏ Nginx
- –ü–æ–ø—Ä–æ–±—É–µ—Ç –ø–æ–ª—É—á–∏—Ç—å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
- –ó–∞–ø—É—Å—Ç–∏—Ç –≤—Å–µ —Å–ª—É–∂–±—ã
</br>
</br>
---
# ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–≤–≤–æ–¥—è—Ç—Å—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ)
    
    # –û—Å–Ω–æ–≤–Ω–æ–π –¥–æ–º–µ–Ω (–±—É–¥–µ—Ç –∑–∞–ø—Ä–æ—à–µ–Ω)
    DOMAIN="your-domain.com"

    # Service –ø–æ–¥–¥–æ–º–µ–Ω—ã (–±—É–¥—É—Ç –∑–∞–ø—Ä–æ—à–µ–Ω—ã)
    Service_DOMAINS=(
        "Service1.your-domain.com"
        "Service2.your-domain.com"
        "Service3.your-domain.com"
    )

# –ü–æ—Ä—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞
    –ü–æ—Ä—Ç  | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ	                            | –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
    443	  | –í–µ—Å—å –≤—Ö–æ–¥—è—â–∏–π HTTPS —Ç—Ä–∞—Ñ–∏–∫	            | –ü—É–±–ª–∏—á–Ω—ã–π
    80	  | HTTP —Ä–µ–¥–∏—Ä–µ–∫—Ç –¥–ª—è SSL	                | –ü—É–±–ª–∏—á–Ω—ã–π
    8443  |	Nginx (—Å–∞–π—Ç, –ª–æ–∫–∞–ª—å–Ω–æ)	                | –õ–æ–∫–∞–ª—å–Ω—ã–π
    8404  |	–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ HAProxy	                    | –ü—É–±–ª–∏—á–Ω—ã–π
    5443  |	Service –±—ç–∫–µ–Ω–¥ –¥–ª—è Service1.domain.com	| –õ–æ–∫–∞–ª—å–Ω—ã–π
    5444  |	Service –±—ç–∫–µ–Ω–¥ –¥–ª—è Service2.domain.com	| –õ–æ–∫–∞–ª—å–Ω—ã–π
    5445  |	Service –±—ç–∫–µ–Ω–¥ –¥–ª—è Service3.domain.com	| –õ–æ–∫–∞–ª—å–Ω—ã–π

# üåê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ DNS

–ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ DNS A –∑–∞–ø–∏—Å–∏:
–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏:

    @           A  ‚Üí IP_–≤–∞—à–µ–≥–æ_—Å–µ—Ä–≤–µ—Ä–∞    # –û—Å–Ω–æ–≤–Ω–æ–π –¥–æ–º–µ–Ω (site.domain.com)
    www         A  ‚Üí IP_–≤–∞—à–µ–≥–æ_—Å–µ—Ä–≤–µ—Ä–∞    # WWW –≤–µ—Ä—Å–∏—è

–ó–∞–ø–∏—Å–∏ –¥–ª—è Service (–ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ø–æ–¥–¥–æ–º–µ–Ω–æ–≤):

    Service1        A  ‚Üí IP_–≤–∞—à–µ–≥–æ_—Å–µ—Ä–≤–µ—Ä–∞    # Service –ø–æ–¥–¥–æ–º–µ–Ω 1
    Service2        A  ‚Üí IP_–≤–∞—à–µ–≥–æ_—Å–µ—Ä–≤–µ—Ä–∞    # Service –ø–æ–¥–¥–æ–º–µ–Ω 2
    Service3        A  ‚Üí IP_–≤–∞—à–µ–≥–æ_—Å–µ—Ä–≤–µ—Ä–∞    # Service –ø–æ–¥–¥–æ–º–µ–Ω 3

# üõ†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Service –±—ç–∫–µ–Ω–¥–æ–≤
–ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –≤–∞—à–∏ Service —Å–µ—Ä–≤–∏—Å—ã –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –ø–æ—Ä—Ç–∞—Ö:

    –ü–æ–¥–¥–æ–º–µ–Ω	            –ü–æ—Ä—Ç	–ü—Ä–∏–º–µ—Ä Service —Å–µ—Ä–≤–∏—Å–∞
    Service1.your-domain.com	5443	Xray, Trojan, V2Ray
    Service2.your-domain.com	5444	gRPC, Hysteria
    Service3.your-domain.com	5445	XTLS, Shadowsocks

# üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ HAProxy:

    URL: http://–≤–∞—à-—Å–µ—Ä–≤–µ—Ä:8404/stats
    –õ–æ–≥–∏–Ω: admin
    –ü–∞—Ä–æ–ª—å: —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (—Å–º. –≤—ã–≤–æ–¥ —Å–∫—Ä–∏–ø—Ç–∞)

# –ö–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
    sudo systemctl status haproxy
    sudo systemctl status nginx

    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–ª—É–∂–±
    sudo systemctl restart haproxy
    sudo systemctl restart nginx

    # –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
    sudo tail -f /var/log/haproxy.log
    sudo tail -f /var/log/nginx/error.log

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
    sudo haproxy -c -f /etc/haproxy/haproxy.cfg
    sudo nginx -t

# üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. –¢–µ—Å—Ç —Å–∞–π—Ç–∞-–∑–∞–≥–ª—É—à–∫–∏:
    
    ```bash
    curl -I https://your-domain.com
    ```

2. –¢–µ—Å—Ç Service –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:

    –ü—Ä–æ–≤–µ—Ä–∫–∞ SNI –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
    ```bash
    openssl s_client -connect –≤–∞—à-—Å–µ—Ä–≤–µ—Ä:443 -servername Service1.your-domain.com
    ```

3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤:

    ```bash
    sudo ss -tulpn | grep ':443'
    ```

4. –¢–µ—Å—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ Service:

    –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ speedtest-cli
    ```bash
    speedtest-cli --server-id=–≤–∞—à-—Å–µ—Ä–≤–µ—Ä
    ```

# üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤
        
    /etc/
    ‚îú‚îÄ‚îÄ haproxy/
    ‚îÇ   ‚îî‚îÄ‚îÄ haproxy.cfg              # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è HAProxy
    ‚îú‚îÄ‚îÄ nginx/
    ‚îÇ   ‚îî‚îÄ‚îÄ sites-available/
    ‚îÇ       ‚îî‚îÄ‚îÄ default             # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx
    ‚îú‚îÄ‚îÄ letsencrypt/live/           # SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
    ‚îÇ   ‚îî‚îÄ‚îÄ your-domain.com/
    ‚îî‚îÄ‚îÄ HAProxy-Nginx.conf     # –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

    /var/www/html/static_page/      # –°–∞–π—Ç-–∑–∞–≥–ª—É—à–∫–∞
    ‚îú‚îÄ‚îÄ index.html
    ‚îú‚îÄ‚îÄ css/
    ‚îî‚îÄ‚îÄ js/

# üêõ –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫
–ü—Ä–æ–±–ª–µ–º–∞: SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
    
    # –ü—Ä–æ–≤–µ—Ä—å—Ç–µ DNS –∑–∞–ø–∏—Å–∏
    nslookup your-domain.com

    # –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ—Ä—Ç–∞ 80
    sudo ufw allow 80

    # –ü–æ–ª—É—á–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≤—Ä—É—á–Ω—É—é
    sudo certbot certonly --nginx -d your-domain.com -d www.your-domain.com

–ü—Ä–æ–±–ª–µ–º–∞: HAProxy –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

    # –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    sudo haproxy -c -f /etc/haproxy/haproxy.cfg

    # –ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏
    sudo journalctl -u haproxy -f

    # –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å ACL
    sudo grep "acl\|use_backend" /etc/haproxy/haproxy.cfg

–ü—Ä–æ–±–ª–µ–º–∞: Service –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è

    # –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é SNI
    sudo tcpdump -i any port 443 -v | grep SNI

    # –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±—ç–∫–µ–Ω–¥—ã
    telnet localhost 5443

    # –ü—Ä–æ–≤–µ—Ä—å—Ç–µ DNS –∫–ª–∏–µ–Ω—Ç–∞
    nslookup Service1.your-domain.com

–ü—Ä–æ–±–ª–µ–º–∞: Nginx –≤—ã–¥–∞–µ—Ç –æ—à–∏–±–∫–∏

    # –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    sudo nginx -t

    # –ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –æ—à–∏–±–∫–∏
    sudo tail -f /var/log/nginx/error.log

    # –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ —Ñ–∞–π–ª–æ–≤
    sudo ls -la /var/www/html/static_page/

# üîÑ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–º

–°–∫—Ä–∏–ø—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –º–µ–Ω—é:

sudo ./setup.sh

    –ú–µ–Ω—é:
    1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–æ–º–µ–Ω—ã (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–Ω–∞—á–∞–ª–∞!)
    2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –í–°–ï –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
    3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ Nginx + static_page
    4. –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–ª—É–∂–±
    6. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–ª—É–∂–±—ã
    7. –£–¥–∞–ª–∏—Ç—å –í–°–ï –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
    0. –í—ã—Ö–æ–¥

# üö® –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏

–ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ DNS –∑–∞–ø–∏—Å–∏ –¥–ª—è –≤—Å–µ—Ö –¥–æ–º–µ–Ω–æ–≤
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Service —Å–µ—Ä–≤–∏—Å—ã –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –ø–æ—Ä—Ç–∞—Ö (5443-5445)
- –ò–∑–º–µ–Ω–∏—Ç–µ –ø–æ–¥–¥–æ–º–µ–Ω—ã –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ:

    ```bash
    # –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª
    sudo nano /etc/haproxy/haproxy.cfg

    # –ù–∞–π–¥–∏—Ç–µ –∏ –∑–∞–º–µ–Ω–∏—Ç–µ (–ø—Ä–∏–º–µ—Ä):
    # –ë—ã–ª–æ: Service1.your-domain.com
    # –°—Ç–∞–ª–æ: real-Service-domain.com
    ```

- –û–±–Ω–æ–≤–∏—Ç–µ –ø–∞—Ä–æ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ HAProxy –µ—Å–ª–∏ –Ω—É–∂–Ω–æ:
    
    ```bash
    sudo nano /etc/haproxy/haproxy.cfg
    # –ù–∞–π–¥–∏—Ç–µ —Å—Ç—Ä–æ–∫—É: stats auth admin:–ø–∞—Ä–æ–ª—å
    ```

# –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:

1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ firewall:
    ```bash
    sudo ufw allow 80/tcp
    sudo ufw allow 443/tcp
    sudo ufw allow 8404/tcp
    sudo ufw enable
    ```

2. –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ª–æ–≥–∏
    ```bash
    sudo tail -f /var/log/haproxy.log | grep -i error
    ```


# üìù –ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã
- ‚ùì –°–∫–æ–ª—å–∫–æ Service –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞?

–û—Ç–≤–µ—Ç: HAProxy –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ 10000 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π.

- ‚ùì –ú–æ–∂–Ω–æ –ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ Service –ø–æ–¥–¥–æ–º–µ–Ω–æ–≤ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏?

–û—Ç–≤–µ—Ç: –î–∞, –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ /etc/haproxy/haproxy.cfg –∏ –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–µ ACL –∏ –±—ç–∫–µ–Ω–¥—ã.

- ‚ùì –ö–∞–∫ –æ–±–Ω–æ–≤–∏—Ç—å static_page?

    ```bash cd /var/www/html/static_page
    git pull origin main
    sudo systemctl restart nginx
    ```

- ‚ùì –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ª–∏ —Å–∫—Ä–∏–ø—Ç IPv6?

–û—Ç–≤–µ—Ç: –î–∞, DNS –∑–∞–ø–∏—Å–∏ AAAA –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è HAProxy.

- ‚ùì –ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏?

    ```bash
    # –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –±—ç–∫–∞–ø—ã, –Ω–æ –º–æ–∂–Ω–æ –≤—Ä—É—á–Ω—É—é:
    sudo cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.backup
    sudo cp /etc/nginx/sites-available/default /etc/nginx/sites-available/default.backup
    ```

- ‚ùì –ú–æ–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö?

–û—Ç–≤–µ—Ç: –î–∞, —Å–∫—Ä–∏–ø—Ç –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞ –∫–∞–∂–¥–æ–º —Å–µ—Ä–≤–µ—Ä–µ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –¥–æ–º–µ–Ω–∞–º–∏.

# ü§ù –í–∫–ª–∞–¥ –≤ —Ä–∞–∑–≤–∏—Ç–∏–µ
–ú—ã –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ–º –≤–∫–ª–∞–¥ –≤ —Ä–∞–∑–≤–∏—Ç–∏–µ –ø—Ä–æ–µ–∫—Ç–∞!
- –§–æ—Ä–∫–Ω–∏—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
- –°–æ–∑–¥–∞–π—Ç–µ –≤–µ—Ç–∫—É –¥–ª—è –≤–∞—à–µ–π —Ñ–∏—á–∏ (git checkout -b feature/amazing-feature)
- –ó–∞–∫–æ–º–º–∏—Ç—å—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (git commit -m 'Add amazing feature')
- –ó–∞–ø—É—à—å—Ç–µ –≤ –≤–µ—Ç–∫—É (git push origin feature/amazing-feature)
- –û—Ç–∫—Ä–æ–π—Ç–µ Pull Request

# –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∫–æ–¥—É:
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º Bash
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ Ubuntu 22.04+


# –¢–∏–ø–∏—á–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
- –∫–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ your-domain.com:443
    ‚Üí HAProxy –≤–∏–¥–∏—Ç –¥–æ–º–µ–Ω –≤ SNI
    ‚Üí –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ 127.0.0.1:5443 (—Å–µ—Ä–≤–µ—Ä 1)

- –í–µ–±-–±—Ä–∞—É–∑–µ—Ä –∑–∞—Ö–æ–¥–∏—Ç –Ω–∞ example.com:443
    ‚Üí HAProxy –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Å ACL
    ‚Üí –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ 127.0.0.1:8443 (Nginx)
    ‚Üí Nginx –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç —Å–∞–π—Ç

# ‚≠ê –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
–ï—Å–ª–∏ —ç—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –±—ã–ª –ø–æ–ª–µ–∑–µ–Ω –¥–ª—è –≤–∞—Å, –ø–æ—Å—Ç–∞–≤—å—Ç–µ –∑–≤–µ–∑–¥—É –Ω–∞ GitHub! ‚≠ê
---
üí° –°–æ–≤–µ—Ç: –î–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–µ—Ä–≤–µ—Ä—ã —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π AES-NI –¥–ª—è –∞–ø–ø–∞—Ä–∞—Ç–Ω–æ–≥–æ —É—Å–∫–æ—Ä–µ–Ω–∏—è TLS.

‚ö†Ô∏è –î–∏—Å–∫–ª–µ–π–º–µ—Ä: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —Ç–æ–ª—å–∫–æ –≤ –∑–∞–∫–æ–Ω–Ω—ã—Ö —Ü–µ–ª—è—Ö. –ê–≤—Ç–æ—Ä—ã –Ω–µ –Ω–µ—Å—É—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –Ω–µ–ø—Ä–∞–≤–æ–º–µ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ.